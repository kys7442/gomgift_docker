server {
    listen 80 default_server;
    server_name test.gomgift.com 192.168.0.24;

    root /var/www/html/yc_gomgift;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;

    # 업로드/버퍼 설정 (실서버와 유사하게)
    client_max_body_size 50m;
    client_body_buffer_size 256k;

    # SmartEditor2 업로더 (실서버 설정 반영)
    location ~ ^/plugin/editor/smarteditor2/photo_uploader/popup/php/?$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$uri/index.php;
        fastcgi_pass php82:9000;
        fastcgi_request_buffering off;
        fastcgi_read_timeout 120;
        fastcgi_buffers 16 256k;
        fastcgi_buffer_size 256k;
    }

    location ~ ^/plugin/editor/smarteditor2/photo_uploader/.*\.php$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php82:9000;
        fastcgi_request_buffering off;
        fastcgi_read_timeout 120;
        fastcgi_buffers 16 256k;
        fastcgi_buffer_size 256k;
    }

    location /plugin/editor/smarteditor2/photo_uploader/ {
        try_files $uri $uri/ =404;
        expires 30d;
        access_log off;
    }

    # 기본 라우팅
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # sitemap.xml (실서버 설정 반영)
    location = /sitemap.xml {
        rewrite ^ /sitemap.php last;
    }

    # robots.txt (실서버 설정 반영)
    location = /robots.txt {
        root  /var/www/html/yc_gomgift;
        default_type text/plain;
        try_files /robots.txt =404;
    }

    # 정적 리소스 캐시 (실서버 설정 반영)
    location ~* \.(?:css|js|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf|otf|eot)$ {
        try_files $uri =404;
        expires 30d;
        access_log off;
    }

    # (선택) 관리자 페이지 fastcgi 버퍼 완화
    location ~ ^/adm/.*\.php$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php82:9000;

        fastcgi_buffers 32 32k;
        fastcgi_buffer_size 64k;
        fastcgi_busy_buffers_size 96k;
        fastcgi_temp_file_write_size 96k;

        fastcgi_read_timeout 120;
        # fastcgi_buffering off;
        # fastcgi_max_temp_file_size 0;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass php82:9000;  # 기본은 PHP 8.2 사용
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # PHP-FPM 타임아웃 설정
        fastcgi_connect_timeout 3000s;
        fastcgi_send_timeout 3000s;
        fastcgi_read_timeout 3000s;
        
        # 버퍼 설정 (성능 최적화)
        fastcgi_buffer_size 64k;
        fastcgi_buffers 4 64k;
        fastcgi_busy_buffers_size 128k;
        fastcgi_temp_file_write_size 128k;
        
        # 캐시 설정 (기본값 사용)
        # fastcgi_cache_bypass $skip_cache;
        # fastcgi_no_cache $skip_cache;
    }

    location ~ /\.ht {
        deny all;
    }
}

